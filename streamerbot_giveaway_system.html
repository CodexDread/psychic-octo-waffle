<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Giveaway — Rewards Spinner</title>
<style>
  :root{
    /* Generic, neutral theme — override freely */
    --bg: #0e0f12;
    --panel: #15171c;
    --text: #e6e6e6;
    --muted: #aeb3bd;
    --accent: #4da3ff;
    --accent-2: #7dffa7;
    --border: #272b33;
    --chip-bg: #1b1e24;
    --chip-br: #303540;
    --danger: #ff6b6b;
    --ok: #7dffa7;
  }
  *{ box-sizing:border-box }
  html,body{ height:100% }
  body{
    margin:0; background:var(--bg); color:var(--text);
    font: 16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, sans-serif;
    display:flex; align-items:center; justify-content:center; overflow:hidden;
  }
  .app{
    width:96vw; height:90vh; padding:16px; background:linear-gradient(180deg, rgba(14,15,18,0.96), rgba(14,15,18,0.9));
    border:1px solid var(--border); border-radius:14px; position:relative; overflow:hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,0.35);
  }
  /* Header */
  .hdr{ display:flex; align-items:center; justify-content:space-between; margin-bottom:12px }
  .title{ font-size:24px; font-weight:700; letter-spacing:.2px }
  .status{
    padding:6px 10px; border:1px solid var(--border); border-radius:8px; background:#11141a; color:var(--muted);
    font-size:14px;
  }

  /* Panels */
  .panel{
    position:absolute; inset:56px 16px 16px 16px;
    background:var(--panel); border:1px solid var(--border); border-radius:12px;
    display:none; place-items:center; overflow:hidden;
  }
  .panel.active{ display:grid }

  /* Timer */
  .timer-box{ display:flex; flex-direction:column; align-items:center; gap:16px }
  .timer-big{ font-size:96px; font-weight:800; letter-spacing:.5px; color:var(--accent) }
  .timer-sub{ font-size:18px; color:var(--muted) }
  .bar{ width:60vw; height:10px; border-radius:999px; position:relative; background:#0f1217; overflow:hidden; border:1px solid var(--border) }
  .bar>i{ position:absolute; inset:0; width:0%; background:var(--accent) }
  .hint{ font-size:16px; color:var(--muted) }
  .hint code{ background:#10131a; padding:2px 6px; border-radius:6px; border:1px solid var(--border); color:var(--text) }

  /* Wheel layout */
  .stage{ width:100%; height:100%; display:grid; grid-template-columns:1fr auto; gap:16px; align-items:center; justify-items:center; padding:16px }
  .wheel-wrap{
    position:relative; width:60vh; height:60vh; min-width:360px; min-height:360px;
    border:1px solid var(--border); border-radius:12px; background:rgba(0,0,0,0.2);
    display:grid; place-items:center; overflow:visible;
  }
  canvas.wheel{ width:100%; height:100% }

  /* ⬇️ Pointer fixed at TOP; rotated 180° per your note */
  .pointer{
    position:absolute; top:-6px; left:50%;
    transform: translateX(-50%) rotate(180deg);
    width:0; height:0;
    border-left:14px solid transparent; border-right:14px solid transparent;
    border-top:22px solid var(--accent); /* points downward after rotate(180deg) */
    filter:drop-shadow(0 0 6px rgba(77,163,255,0.65));
    z-index:3;
  }
  .legend{ font-size:14px; color:var(--muted); margin-top:8px }

  .side{
    width:28vw; max-width:540px; min-width:280px; height:100%;
    border:1px solid var(--border); border-radius:12px; padding:12px; overflow:auto; background:#11141a;
  }
  .side h3{ margin:4px 0 10px; font-size:18px; letter-spacing:.2px }
  .chip{
    border:1px solid var(--chip-br);
    background:var(--chip-bg);
    padding:8px 10px; margin:6px 0; border-radius:10px;
    font-size:16px; color:var(--text); display:flex; align-items:center; gap:8px;
  }
  .chip .dot{
    width:8px; height:8px; border-radius:50%; background:var(--accent-2);
    box-shadow:0 0 8px rgba(125,255,167,0.45);
  }

  /* DEV */
  .dev{
    position:absolute; right:12px; top:12px; z-index:30; display:flex; gap:6px; flex-wrap:wrap; max-width:40vw;
    background:#0f1217; border:1px solid var(--border); border-radius:10px; padding:8px;
  }
  .dev button{
    font: inherit; font-size:14px; padding:6px 10px; cursor:pointer;
    border:1px solid var(--border); border-radius:8px; background:#12151b; color:var(--text);
  }
  .dev .note{ color:var(--muted); font-size:12px; width:100% }

  /* FX layer */
  #fx{ position:absolute; inset:0; pointer-events:none; z-index:5 }

  .visually-hidden{ position:absolute; width:1px; height:1px; margin:-1px; border:0; padding:0; clip:rect(0 0 0 0); overflow:hidden }
</style>
</head>
<body>
<div class="app" role="application" aria-label="Giveaway Spinner">

  <div class="hdr">
    <div class="title">Giveaway</div>
    <div class="status" id="status">idle</div>
  </div>

  <!-- Timer -->
  <section class="panel" id="p-timer" aria-live="polite">
    <div class="timer-box">
      <div class="timer-big" id="time">00:30</div>
      <div class="timer-sub">entries: <span id="pcount">0</span></div>
      <div class="bar" aria-hidden="true"><i id="barfill"></i></div>
      <div class="hint">Type <code id="cmd">!enter</code> in chat to join</div>
    </div>
  </section>

  <!-- Users wheel -->
  <section class="panel" id="p-users">
    <div class="stage">
      <div class="wheel-wrap">
        <div class="pointer" aria-hidden="true"></div>
        <canvas class="wheel" id="wheel-users" width="1024" height="1024" aria-label="Participants wheel"></canvas>
        <div class="legend">participants</div>
      </div>
      <aside class="side" aria-live="polite">
        <h3>Winner</h3>
        <div id="winner-slot"></div>
      </aside>
    </div>
  </section>

  <!-- Rewards wheel -->
  <section class="panel" id="p-rewards">
    <div class="stage">
      <div class="wheel-wrap">
        <div class="pointer" aria-hidden="true"></div>
        <canvas class="wheel" id="wheel-rewards" width="1024" height="1024" aria-label="Rewards wheel"></canvas>
        <div class="legend">rewards</div>
      </div>
      <aside class="side" aria-live="polite">
        <h3>Selected Rewards</h3>
        <div id="rewards-picked"></div>
      </aside>
    </div>
  </section>

  <!-- FX -->
  <canvas id="fx"></canvas>

  <!-- DEV tools (disable with CONFIG.SHOW_TEST_UI=false) -->
  <div class="dev" id="dev">
    <button id="dev-start">Start (DEV)</button>
    <button id="dev-add">+ Random User</button>
    <button id="dev-fast">Fast Timer</button>
    <div class="note">Streamer.bot should call <code>GIVEAWAY_API.start()</code> and <code>GIVEAWAY_API.addParticipant("name")</code>.</div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
<script>
/* ===========================
   CONFIG (generic)
   =========================== */
const CONFIG = {
  TIMER_SECONDS: 30,
  REWARD_SPINS: 3,
  COMMAND: '!enter',              // UI hint only; SB listens & calls addParticipant()
  SHOW_TEST_UI: true,
  REWARDS_CSV_PATH: './rewards.csv',
  COLORS: {                       // used by canvas wheel labels
    text: getCss('--text'),
    border: getCss('--border'),
    sliceA: 'rgba(77,163,255,0.22)',
    sliceB: 'rgba(125,255,167,0.20)'
  }
};
function getCss(varName){
  return getComputedStyle(document.documentElement).getPropertyValue(varName).trim();
}

/* ===========================
   STATE (public)
   =========================== */
const GIVEAWAY_STATE = {
  participants: [],
  winner: null,
  rewards: [],
  running: false,
  startedAt: null
};
window.GIVEAWAY_STATE = GIVEAWAY_STATE;

/* ===========================
   DOM refs
   =========================== */
const $ = s => document.querySelector(s);
const panels = { timer: $('#p-timer'), users: $('#p-users'), rewards: $('#p-rewards') };
const statusEl = $('#status'), timeEl = $('#time'), pcountEl = $('#pcount'), cmdEl = $('#cmd'), barfill = $('#barfill');
const winnerSlot = $('#winner-slot'), rewardsPicked = $('#rewards-picked');

/* ===========================
   Helpers
   =========================== */
const fmt = n => String(n).padStart(2,'0');
const mmss = sec => `${fmt(Math.floor(sec/60))}:${fmt(Math.max(0,Math.floor(sec%60)))}`;
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function showPanel(p){ p.classList.add('active'); p.style.opacity=0; p.style.transform='translateY(8px) scale(0.995)';
  await anime({targets:p, opacity:[0,1], translateY:[8,0], scale:[0.995,1], duration:350, easing:'easeOutQuad'}).finished; }
async function hidePanel(p){ await anime({targets:p, opacity:[1,0], translateY:[0,8], scale:[1,0.995], duration:250, easing:'easeInQuad'}).finished; p.classList.remove('active'); }

/* ===========================
   Wheel (canvas)
   =========================== */
class Wheel {
  constructor(canvas, options=[]){
    this.canvas = canvas;
    this.ctx = canvas.getContext('2d');
    this.options = [...options];
    this.rotation = 0;
  }
  setOptions(opts){ this.options = [...opts]; this.draw(); }
  _sliceColor(i){ return i%2 ? CONFIG.COLORS.sliceA : CONFIG.COLORS.sliceB; }
  draw(){
    const {ctx, canvas} = this;
    const N = Math.max(this.options.length,1);
    const cx = canvas.width/2, cy = canvas.height/2, r = Math.min(cx,cy)-6;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.save(); ctx.translate(cx,cy); ctx.rotate(this.rotation);

    for(let i=0;i<N;i++){
      const a0 = (i/N)*2*Math.PI, a1 = ((i+1)/N)*2*Math.PI;
      ctx.beginPath(); ctx.moveTo(0,0); ctx.arc(0,0,r,a0,a1); ctx.closePath();
      ctx.fillStyle = this._sliceColor(i); ctx.fill();
      ctx.strokeStyle = CONFIG.COLORS.border; ctx.lineWidth = 2; ctx.stroke();

      // label
      const mid = (a0+a1)/2;
      ctx.save(); ctx.rotate(mid); ctx.translate(r*0.72,0); ctx.rotate(Math.PI/2);
      ctx.fillStyle = CONFIG.COLORS.text; ctx.font = '20px system-ui, sans-serif'; ctx.textAlign='center';
      const txt = String(this.options[i]).slice(0,24);
      ctx.fillText(txt,0,0);
      ctx.restore();
    }
    ctx.restore();

    // hub
    ctx.beginPath(); ctx.arc(cx,cy,26,0,2*Math.PI);
    ctx.fillStyle = getCss('--accent'); ctx.shadowColor = getCss('--accent'); ctx.shadowBlur=14; ctx.fill(); ctx.shadowBlur=0;
  }

  /* ✅ Fix: land at TOP (12 o'clock).
     We want mid + rotation = -π/2 (top). So:
     rotation_target = (2π*revs) - π/2 - (index+0.5)*slice
  */
  spinToIndex(index, {revs=6, duration=4500, easing='easeOutQuart'}={}){
    const N = Math.max(this.options.length,1);
    const slice = (2*Math.PI)/N;
    const target = (2*Math.PI*revs) - (Math.PI/2) - (index + 0.5)*slice;
    return new Promise(resolve=>{
      anime({ targets:this, rotation:[this.rotation, target], duration, easing,
        update: ()=> this.draw(),
        complete: ()=>{ this.rotation = target%(2*Math.PI); resolve(); }
      });
    });
  }
}

/* ===========================
   Three.js burst
   =========================== */
class FX {
  constructor(canvas){
    this.canvas = canvas;
    this.scene = new THREE.Scene();
    this.camera = new THREE.PerspectiveCamera(45, canvas.clientWidth/canvas.clientHeight, 0.1, 1000);
    this.renderer = new THREE.WebGLRenderer({canvas, alpha:true, antialias:true});
    this.renderer.setSize(canvas.clientWidth, canvas.clientHeight, false);
    this.camera.position.z = 5;
    this.clock = new THREE.Clock();
    this.bursts = [];
    addEventListener('resize', ()=>this.resize());
    this.resize();
    this.loop();
  }
  resize(){
    const w = this.canvas.clientWidth, h = this.canvas.clientHeight;
    this.renderer.setSize(w,h,false); this.camera.aspect = w/h; this.camera.updateProjectionMatrix();
  }
  loop(){
    requestAnimationFrame(()=>this.loop());
    const dt = this.clock.getDelta();
    for(let i=this.bursts.length-1;i>=0;i--){
      const pts = this.bursts[i], pos = pts.geometry.attributes.position, vel = pts.geometry.attributes.velocity;
      for(let j=0;j<pos.count;j++){
        pos.array[j*3+0]+=vel.array[j*3+0]*dt;
        pos.array[j*3+1]+=vel.array[j*3+1]*dt;
        pos.array[j*3+2]+=vel.array[j*3+2]*dt;
      }
      pos.needsUpdate = true;
      pts.userData.life += dt;
      pts.material.opacity = Math.max(0,1-pts.userData.life/0.9);
      if (pts.userData.life>0.9){ this.scene.remove(pts); pts.geometry.dispose(); pts.material.dispose(); this.bursts.splice(i,1); }
    }
    this.renderer.render(this.scene,this.camera);
  }
  burst(){
    const count=110, geom=new THREE.BufferGeometry();
    const pos=new Float32Array(count*3), vel=new Float32Array(count*3);
    for(let i=0;i<count;i++){
      const a=Math.random()*Math.PI*2, s=Math.random()*1.6+0.5;
      pos[i*3]=0; pos[i*3+1]=0; pos[i*3+2]=0;
      vel[i*3]=Math.cos(a)*s; vel[i*3+1]=Math.sin(a)*s; vel[i*3+2]=(Math.random()-0.5)*0.3;
    }
    geom.setAttribute('position', new THREE.BufferAttribute(pos,3));
    geom.setAttribute('velocity', new THREE.BufferAttribute(vel,3));
    const mat=new THREE.PointsMaterial({ size:0.05, color:getCss('--accent'), transparent:true, opacity:1 });
    const pts=new THREE.Points(geom,mat); pts.userData.life=0; this.scene.add(pts); this.bursts.push(pts);
  }
}
const fx = new FX(document.getElementById('fx'));

/* ===========================
   Rewards CSV (supports weights: "Reward,weight")
   =========================== */
async function loadRewardsWeighted(){
  try{
    const r = await fetch(CONFIG.REWARDS_CSV_PATH, {cache:'no-store'});
    if(!r.ok) throw new Error('fetch failed');
    const txt = await r.text();
    const lines = txt.split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
    const pool = [];
    for(const ln of lines){
      const [name, wStr] = ln.split(',').map(s=>String(s||'').trim());
      const w = Math.max(1, parseInt(wStr||'1',10) || 1);
      for(let i=0;i<w;i++) pool.push(name);
    }
    return pool.length? pool : ['Sticker','Emote Unlock','Discord Role','Hydrate','Stretch','Spin Again'];
  }catch{
    return ['Sticker','Emote Unlock','Discord Role','Hydrate','Stretch','Spin Again'];
  }
}

/* ===========================
   Flow
   =========================== */
let usersWheel, rewardsWheel;
let rewardsPoolWeighted = [];   // changes as picks become unavailable
let rewardsUniqueCount = 0;

function buildWheels(){
  usersWheel = new Wheel(document.getElementById('wheel-users'), GIVEAWAY_STATE.participants);
  usersWheel.draw();
  rewardsWheel = new Wheel(document.getElementById('wheel-rewards'), rewardsPoolWeighted);
  rewardsWheel.draw();
}

async function startTimer(){
  await showPanel(panels.timer);
  statusEl.textContent = 'entries open';
  cmdEl.textContent = CONFIG.COMMAND;

  const total = CONFIG.TIMER_SECONDS;
  let t = total;
  timeEl.textContent = mmss(t);
  barfill.style.width = '0%';
  anime({ targets: barfill, width: ['0%','100%'], easing:'linear', duration: total*1000 });

  return new Promise(res=>{
    const iv = setInterval(()=>{
      t--; timeEl.textContent = mmss(Math.max(0,t));
      pcountEl.textContent = GIVEAWAY_STATE.participants.length;
      if (t<=0){ clearInterval(iv); res(); }
    },1000);
  });
}

async function spinUsers(){
  await hidePanel(panels.timer);

  usersWheel.setOptions(GIVEAWAY_STATE.participants.length ? GIVEAWAY_STATE.participants : ['No Entries']);
  await showPanel(panels.users);
  statusEl.textContent = 'picking winner…';

  const N = usersWheel.options.length;
  const idx = Math.floor(Math.random()*N);
  await usersWheel.spinToIndex(idx, {revs:7, duration:5200});
  fx.burst();

  const winner = usersWheel.options[idx];
  GIVEAWAY_STATE.winner = winner;

  winnerSlot.innerHTML = '';
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.innerHTML = `<span class="dot"></span> ${winner}`;
  chip.style.opacity = 0; chip.style.transform = 'translateY(-6px)';
  winnerSlot.appendChild(chip);
  await anime({targets: chip, opacity:[0,1], translateY:[-6,0], duration:420, easing:'easeOutQuad'}).finished;

  await sleep(800);
  await hidePanel(panels.users);
}

function addRewardChip(text){
  const chip = document.createElement('div');
  chip.className = 'chip';
  chip.innerHTML = `<span class="dot"></span> ${text}`;
  chip.style.opacity=0; chip.style.transform='translateX(12px)';
  rewardsPicked.appendChild(chip);
  anime.timeline()
    .add({ targets: chip, opacity:[0,1], translateX:[12,0], duration:420, easing:'easeOutQuad'})
    .add({ targets: chip, scale:[1,1.05,1], duration:320, easing:'easeInOutSine'});
}

/* === UNIQUE REWARD LOGIC (no duplicates) === */
async function spinRewardsUnique(){
  rewardsWheel.setOptions(rewardsPoolWeighted);
  await showPanel(panels.rewards);

  const uniqueAvailable = new Set(rewardsPoolWeighted).size;
  const spins = Math.min(CONFIG.REWARD_SPINS, uniqueAvailable);
  if (CONFIG.REWARD_SPINS > uniqueAvailable){
    statusEl.textContent = `rolling rewards… (capped to ${spins}/${CONFIG.REWARD_SPINS})`;
  } else {
    statusEl.textContent = 'rolling rewards…';
  }

  GIVEAWAY_STATE.rewards = [];
  const chosen = new Set();

  for (let i=0;i<spins;i++){
    const allowedIdx = [];
    for (let j=0;j<rewardsWheel.options.length;j++){
      if (!chosen.has(rewardsWheel.options[j])) allowedIdx.push(j);
    }
    if (!allowedIdx.length) break;

    const pickIdx = allowedIdx[Math.floor(Math.random()*allowedIdx.length)];
    await rewardsWheel.spinToIndex(pickIdx, {revs:6+Math.floor(Math.random()*3), duration:4200+Math.floor(Math.random()*800)});
    fx.burst();

    const prize = rewardsWheel.options[pickIdx];
    chosen.add(prize);
    GIVEAWAY_STATE.rewards.push(prize);
    addRewardChip(prize);

    // remove all instances of chosen prize from the weighted pool
    rewardsPoolWeighted = rewardsPoolWeighted.filter(x => x !== prize);
    rewardsWheel.setOptions(rewardsPoolWeighted);

    await sleep(650);
  }

  statusEl.textContent = 'complete';
  await sleep(1000);
  await hidePanel(panels.rewards);

  statusEl.textContent = `winner: ${GIVEAWAY_STATE.winner ?? '—'} | rewards: ${GIVEAWAY_STATE.rewards.join(' , ') || '—'}`;
}

/* ===========================
   Public API (Streamer.bot hooks)
   =========================== */
window.GIVEAWAY_API = {
  async start(overrides={}){
    if (typeof overrides.timerSeconds==='number') CONFIG.TIMER_SECONDS = Math.max(3, overrides.timerSeconds|0);
    if (typeof overrides.rewardSpins==='number') CONFIG.REWARD_SPINS = Math.max(1, overrides.rewardSpins|0);
    if (typeof overrides.rewardsCsvPath==='string') CONFIG.REWARDS_CSV_PATH = overrides.rewardsCsvPath;

    GIVEAWAY_STATE.participants = [];
    GIVEAWAY_STATE.winner = null;
    GIVEAWAY_STATE.rewards = [];
    rewardsPicked.innerHTML = '';
    winnerSlot.innerHTML = '';
    statusEl.textContent = 'loading rewards…';
    GIVEAWAY_STATE.running = true;
    GIVEAWAY_STATE.startedAt = Date.now();

    rewardsPoolWeighted = await loadRewardsWeighted();
    rewardsUniqueCount = new Set(rewardsPoolWeighted).size;

    buildWheels();

    await startTimer();
    statusEl.textContent = 'entries closed';

    await spinUsers();
    await spinRewardsUnique();

    GIVEAWAY_STATE.running = false;
  },

  addParticipant(username){
    if (!GIVEAWAY_STATE.running) return;
    const name = String(username||'').trim();
    if (!name) return;
    if (!GIVEAWAY_STATE.participants.includes(name)){
      GIVEAWAY_STATE.participants.push(name);
      pcountEl.textContent = GIVEAWAY_STATE.participants.length;
      anime({targets: barfill, scaleY:[1,1.12,1], duration:300, easing:'easeInOutSine'});
    }
  },

  stop(){
    GIVEAWAY_STATE.running = false;
    statusEl.textContent = 'stopped';
    Object.values(panels).forEach(p=>p.classList.remove('active'));
  },

  getWinner(){ return GIVEAWAY_STATE.winner; },
  getRewards(){ return [...GIVEAWAY_STATE.rewards]; },
  getParticipants(){ return [...GIVEAWAY_STATE.participants]; }
};

/* ===========================
   Init + DEV hooks
   =========================== */
(async function init(){
  document.getElementById('dev').style.display = CONFIG.SHOW_TEST_UI ? 'flex' : 'none';

  rewardsPoolWeighted = await loadRewardsWeighted();
  rewardsUniqueCount = new Set(rewardsPoolWeighted).size;
  buildWheels();

  if (CONFIG.SHOW_TEST_UI){
    $('#dev-start').onclick = ()=> window.GIVEAWAY_API.start();
    $('#dev-add').onclick = ()=>{
      const n = 'user'+Math.floor(Math.random()*9999).toString().padStart(4,'0');
      window.GIVEAWAY_API.addParticipant(n);
    };
    $('#dev-fast').onclick = ()=>{ CONFIG.TIMER_SECONDS = 3; };
  }
})();
</script>
</body>
</html>
